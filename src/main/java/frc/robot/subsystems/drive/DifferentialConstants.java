// Copyright (c) FIRST and other WPILib contributors.
// Open Source Software; you can modify and/or share it under the terms of
// the WPILib BSD license file in the root directory of this project.

package frc.robot.subsystems.drive;

import com.pathplanner.lib.config.RobotConfig;
import com.pathplanner.lib.config.ModuleConfig;

import edu.wpi.first.math.system.plant.DCMotor;
import edu.wpi.first.math.util.Units;

/**
 * Constants for the differential drive subsystem
 */
public final class DifferentialConstants {
  // ==================== Physical Robot Parameters ====================
  
  /**
   * Track width (distance between left and right wheels) in meters
   * Measure from the center of one wheel to the center of the other
   */
  public static final double kTrackWidthMeters = Units.inchesToMeters(21.625); // TODO: Measure your robot

  /**
   * Track length (distance between center of front wheel to back wheel) in meters
   * Measure from the center of one wheel to the center of the other
   */
  public static final double kTrackLengthMeters = Units.inchesToMeters(18); // TODO: Measure your robot
  
  /**
   * The robot's mass in kilograms
   */
  public static final double kRobotMassKg = Units.lbsToKilograms(110.0); // TODO: Measure your robot

  /**
   * Calculate the robot's moment of inertia - MOI (kg*m²)
   * MOI = 1/12 * mass * (lengthSquared + widthSquared)
   */
  public static final double kRobotMOI = 1/12 * kRobotMassKg * (Math.pow(kTrackLengthMeters, 2) + Math.pow(kTrackWidthMeters, 2));
  
  /**
   * Wheel diameter in meters
   */
  public static final double kWheelDiameterMeters = Units.inchesToMeters(6); // 6 inches = 0.1524 meters
  
  /**
   * Wheel circumference in meters
   */
  public static final double kWheelCircumferenceMeters = kWheelDiameterMeters * Math.PI;
  
  /**
   * Gear ratio from motor to wheel
   * If motor spins X times, wheel spins 1 time
   * Example: 10.71:1 gearbox means motor spins 10.71 times per wheel rotation
   */
  public static final double kGearRatio = 8.45; // TODO: Check your gearbox
  
  /**
   * Rev through bore encoder v2 resolution (ticks per motor revolution)
   * Rev through bore encoder v2 encoders report 8192 counts per revolution by default
   */
  public static final double kEncoderTicksPerRevolution = 8192.0;
  
  /**
   * Position conversion factor: converts encoder ticks to meters
   * Formula: (wheel circumference) / (gear ratio * encoder ticks per rev)
   */
  public static final double kPositionConversionFactor = kWheelCircumferenceMeters / (kGearRatio * kEncoderTicksPerRevolution);
  
  /**
   * Velocity conversion factor: converts encoder ticks/minute to meters/second
   * Formula: position conversion factor / 60 (to convert minutes to seconds)
   */
  public static final double kVelocityConversionFactor = kPositionConversionFactor / 60.0;
  
  // ==================== Drive Control Parameters ====================
  
  /**
   * Maximum speed in meters per second
   * Typical values: 2-4 m/s for FRC drivetrains
   */
  public static final double kMaxSpeedMetersPerSecond = 3.0; // TODO: Characterize your robot
  
  /**
   * Maximum acceleration in meters per second squared
   */
  public static final double kMaxAccelMetersPerSecondSq = 2.0; // TODO: Characterize your robot
  
  /**
   * Maximum angular speed in radians per second
   */
  public static final double kMaxAngularSpeedRadsPerSecond = 2.0 * Math.PI; // TODO: Characterize
  
  /**
   * Maximum angular acceleration in radians per second squared
   */
  public static final double kMaxAngularAccelRadsPerSecondSq = Math.PI; // TODO: Characterize
  
  // ==================== Joystick Control Parameters ====================
  
  /**
   * Joystick deadband (ignore inputs below this threshold)
   */
  public static final double kJoystickDeadband = 0.1;
  
  /**
   * Translational slew rate limit (units per second)
   * Limits how quickly forward/backward speed can change
   */
  public static final double kTranslationalSlewRateLimit = 5.0;
  
  /**
   * Rotational slew rate limit (units per second)
   * Limits how quickly rotation speed can change
   */
  public static final double kRotationalSlewRateLimit = 3.0;
  
  /**
   * Translation scaling factor (0.0 to 1.0)
   * Reduces max speed for finer control
   */
  public static final double kTranslationScaling = 0.8;
  
  /**
   * Rotation scaling factor (0.0 to 1.0)
   * Reduces max rotation for finer control
   */
  public static final double kRotationScaling = 0.6;
  
  // ==================== PID Constants for Velocity Control ====================
  
  /**
   * PID proportional gain for velocity control
   */
  public static final double kP = 0.0002; // TODO: Tune this value
  
  /**
   * Feedforward kS - voltage needed to overcome static friction
   * Units: Volts
   */
  public static final double kS = 0.22; // TODO: Use SysId to characterize
  
  /**
   * Feedforward kV - voltage needed per unit of velocity
   * Units: Volt-seconds/meter
   */
  public static final double kV = 2.6; // TODO: Use SysId to characterize
  
  /**
   * Feedforward kA - voltage needed per unit of acceleration
   * Units: Volt-seconds²/meter
   */
  public static final double kA = 0.4; // TODO: Use SysId to characterize
  
  // ==================== PID Constants for Aiming ====================
  
  /**
   * Aiming PID proportional gain
   */
  public static final double kAimP = 2.0; // TODO: Tune this value
  
  /**
   * Aiming PID integral gain
   */
  public static final double kAimI = 0.0;
  
  /**
   * Aiming PID derivative gain
   */
  public static final double kAimD = 0.1; // TODO: Tune this value
  
  /**
   * Aiming tolerance in radians (how close is "good enough")
   */
  public static final double kAimToleranceRad = Units.degreesToRadians(2.0);
  
  // ==================== Vision Parameters ====================
  
  /**
   * Maximum age of vision measurements to accept (seconds)
   */
  public static final double kVisionMeasurementMaxAge = 0.3;
  
  /**
   * Maximum allowed translation jump for vision measurements (meters)
   * Rejects vision measurements that are too far from current estimate
   */
  public static final double kVisionMaxTranslationJump = 1.0;
  
  /**
   * Maximum allowed rotation jump for vision measurements (degrees)
   * Rejects vision measurements with too much rotation difference
   */
  public static final double kVisionMaxRotationJump = 30.0;
  
  // ==================== PathPlanner Configuration ====================
  
  /**
   * Robot configuration for PathPlanner
   * This is used by PathPlanner for trajectory generation
   */
  public static final RobotConfig kRobotConfig = new RobotConfig(
    kRobotMassKg,                   // mass (kg)
    kRobotMOI,                      // MOI (kg*m²)
    new ModuleConfig(
      kWheelDiameterMeters / 2.0,   // wheel radius (m)
      kMaxSpeedMetersPerSecond,     // max wheel speed (m/s)
      1.19,                // wheel COF
      DCMotor.getCIM(1),  // drive motors: 1 CIM per side
      60.0,       // current limit (A)
      2                   // number of motors per module
    ),
    kTrackWidthMeters / 2.0         // module locations (just half track width for differential)
  );
}
